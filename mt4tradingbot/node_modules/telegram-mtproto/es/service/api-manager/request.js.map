{"version":3,"sources":["../../../src/service/api-manager/request.js"],"names":["Promise","Logger","debug","MTError","delayedCall","Request","constructor","config","method","params","initNetworker","networker","getNetworker","netOpts","dc","then","saveNetworker","resolve","performRequest","requestWith","wrapApiCall","catch","code","error303","error420","bind","err","matched","type","match","length","reject","newDcID","waitTime","console","error"],"mappings":"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","file":"request.js","sourcesContent":["//@flow\r\n\r\nimport Promise from 'bluebird'\r\n\r\nimport Logger from '../../util/log'\r\nconst debug = Logger([`request`])\r\n\r\nimport { MTError } from '../../error'\r\nimport { delayedCall } from '../../util/smart-timeout'\r\nimport type { NetworkerType, AsyncStorage, LeftOptions } from './index.h.js'\r\n\r\ntype Options = {|\r\n  networker?: NetworkerType,\r\n  dc: number,\r\n  storage: AsyncStorage,\r\n  getNetworker: (dcID: number, options: LeftOptions) => Promise<NetworkerType>,\r\n  netOpts: mixed\r\n|}\r\n\r\nclass Request {\r\n  method: string\r\n  params: { [arg: string]: mixed }\r\n  config: Options\r\n  constructor(config: Options, method: string, params?: Object = {}) {\r\n    this.config = config\r\n    this.method = method\r\n    this.params = params\r\n\r\n    this.performRequest = this.performRequest.bind(this)\r\n    //$FlowIssue\r\n    this.error303 = this.error303.bind(this)\r\n    //$FlowIssue\r\n    this.error420 = this.error420.bind(this)\r\n    this.initNetworker = this.initNetworker.bind(this)\r\n  }\r\n  initNetworker = (): Promise<NetworkerType> => {\r\n    if (!this.config.networker) {\r\n      const { getNetworker, netOpts, dc } = this.config\r\n      return getNetworker(dc, netOpts)\r\n        .then(this.saveNetworker)\r\n    }\r\n    return Promise.resolve(this.config.networker)\r\n  }\r\n  saveNetworker = (networker: NetworkerType) => this.config.networker = networker\r\n  performRequest = () => this.initNetworker().then(this.requestWith)\r\n  requestWith = (networker: NetworkerType) => networker\r\n    .wrapApiCall(this.method, this.params, this.config.netOpts)\r\n    .catch({ code: 303 }, this.error303)\r\n    .catch({ code: 420 }, this.error420)\r\n  error303(err: MTError) {\r\n    const matched = err.type.match(/^(PHONE_MIGRATE_|NETWORK_MIGRATE_|USER_MIGRATE_)(\\d+)/)\r\n    if (!matched || matched.length < 2) return Promise.reject(err)\r\n    const [ , , newDcID] = matched\r\n    if (+newDcID === this.config.dc) return Promise.reject(err)\r\n    this.config.dc = +newDcID\r\n    delete this.config.networker\r\n    /*if (this.config.dc)\r\n      this.config.dc = newDcID\r\n    else\r\n      await this.config.storage.set('dc', newDcID)*/\r\n    //TODO There is disabled ability to change default DC\r\n    //NOTE Shouldn't we must reassign current networker/cachedNetworker?\r\n    return this.performRequest()\r\n  }\r\n  error420(err: MTError) {\r\n    const matched = err.type.match(/^FLOOD_WAIT_(\\d+)/)\r\n    if (!matched || matched.length < 2) return Promise.reject(err)\r\n    const [ , waitTime ] = matched\r\n    console.error(`Flood error! It means that mtproto server bans you on ${waitTime} seconds`)\r\n    return +waitTime > 60\r\n      ? Promise.reject(err)\r\n      : delayedCall(this.performRequest, +waitTime * 1e3)\r\n  }\r\n}\r\n\r\nexport default Request"]}