{"version":3,"sources":["../../src/tl/type-buffer.js"],"names":["isNode","Logger","log","immediate","TypeBufferIntError","findType","val","type","findPred","predicate","findId","id","getNakedType","schema","checkType","substr","result","constructors","find","Error","getPredicate","getTypeConstruct","construct","getChar","e","String","fromCharCode","getString","length","buffer","bytes","next","map","join","addPadding","countNewLength","maxLength","need","offset","e1","e2","max","Math","rounded","ceil","writeIntLogger","writeIntLog","i","field","hex","toString","TypeWriter","constructor","reset","ArrayBuffer","intView","Int32Array","byteView","Uint8Array","set","list","data","checkLength","needBytes","previousBuffer","previousArray","getArray","resultBuffer","resultArray","subarray","getBuffer","getBytesTyped","getBytesPlain","push","writeInt","writePair","n1","n2","field1","field2","TypeBuffer","toUint32","nextByte","nextInt","int","readPair","int1","int2","isEnd","buf","ln","res","Uint32Array","readUInt32LE","byteLength","DataView","getUint32"],"mappings":"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","file":"type-buffer.js","sourcesContent":["//@flow\r\n\r\nimport isNode from 'detect-node'\r\n\r\nimport Logger from '../util/log'\r\nconst log = Logger('tl', 'type-buffer')\r\n\r\nimport { immediate } from '../util/smart-timeout'\r\nimport { TypeBufferIntError } from '../error'\r\n\r\n// import { bigint, uintToInt, intToUint, bytesToHex,\r\n//   gzipUncompress, bytesToArrayBuffer, longToInts, lshift32 } from '../bin'\r\n\r\nimport type { BinaryData, TLConstruct, TLSchema } from './index.h'\r\n\r\nfunction findType(val: TLConstruct) {\r\n  return val.type == this\r\n}\r\n\r\nfunction findPred(val: TLConstruct) {\r\n  return val.predicate == this\r\n}\r\n\r\nfunction findId(val: TLConstruct) {\r\n  return val.id == this\r\n}\r\n\r\nexport const getNakedType = (type: string, schema: TLSchema) => {\r\n  const checkType = type.substr(1)\r\n  const result = schema.constructors.find(findType, checkType)\r\n  if (!result)\r\n    throw new Error(`Constructor not found for type: ${type}`)\r\n  return result\r\n}\r\n\r\nexport const getPredicate = (type: string, schema: TLSchema) => {\r\n  const result = schema.constructors.find(findPred, type)\r\n  if (!result)\r\n    throw new Error(`Constructor not found for predicate: ${type}`)\r\n  return result\r\n}\r\n\r\nexport const getTypeConstruct =\r\n  (construct: number, schema: TLSchema) =>\r\n    schema.constructors.find(findId, construct)\r\n\r\nconst getChar = (e: number) => String.fromCharCode(e)\r\n\r\nexport const getString = (length: number, buffer: TypeBuffer) => {\r\n  const bytes = buffer.next(length)\r\n\r\n  const result = [...bytes].map(getChar).join('')\r\n  buffer.addPadding()\r\n  return result\r\n}\r\n\r\nconst countNewLength = (maxLength: number, need: number, offset: number) => {\r\n  const e1 = maxLength * 2\r\n  const e2 = offset + need + 16\r\n  const max = Math.max(e1, e2) / 4\r\n  const rounded = Math.ceil(max) * 4\r\n  return rounded\r\n}\r\n\r\nconst writeIntLogger = log('writeInt')\r\n\r\nconst writeIntLog = (i: number, field: string) => {\r\n  const hex = i && i.toString(16) || 'UNDEF'\r\n  writeIntLogger(hex, i, field)\r\n}\r\n\r\nexport class TypeWriter {\r\n  offset: number = 0 // in bytes\r\n  buffer: ArrayBuffer\r\n  intView: Int32Array\r\n  byteView: Uint8Array\r\n  maxLength: number\r\n  constructor(/*startMaxLength: number*/) {\r\n    // this.maxLength = startMaxLength\r\n    // this.reset()\r\n  }\r\n  reset() {\r\n    this.buffer = new ArrayBuffer(this.maxLength)\r\n    this.intView = new Int32Array(this.buffer)\r\n    this.byteView = new Uint8Array(this.buffer)\r\n  }\r\n  set(list: BinaryData, length: number) {\r\n    this.byteView.set(list, this.offset)\r\n    this.offset += length\r\n  }\r\n  next(data: number) {\r\n    this.byteView[this.offset] = data\r\n    this.offset++\r\n  }\r\n  checkLength(needBytes: number) {\r\n    if (this.offset + needBytes < this.maxLength) {\r\n      return\r\n    }\r\n    log('Increase buffer')(this.offset, needBytes, this.maxLength)\r\n    this.maxLength = countNewLength(\r\n      this.maxLength,\r\n      needBytes,\r\n      this.offset\r\n    )\r\n    const previousBuffer = this.buffer\r\n    const previousArray = new Int32Array(previousBuffer)\r\n\r\n    this.reset()\r\n\r\n    new Int32Array(this.buffer).set(previousArray)\r\n  }\r\n  getArray() {\r\n    const resultBuffer = new ArrayBuffer(this.offset)\r\n    const resultArray = new Int32Array(resultBuffer)\r\n\r\n    resultArray.set(this.intView.subarray(0, this.offset / 4))\r\n\r\n    return resultArray\r\n  }\r\n  getBuffer() {\r\n    return this.getArray().buffer\r\n  }\r\n  getBytesTyped() {\r\n    const resultBuffer = new ArrayBuffer(this.offset)\r\n    const resultArray = new Uint8Array(resultBuffer)\r\n\r\n    resultArray.set(this.byteView.subarray(0, this.offset))\r\n\r\n    return resultArray\r\n  }\r\n  getBytesPlain() {\r\n    const bytes = []\r\n    for (let i = 0; i < this.offset; i++) {\r\n      bytes.push(this.byteView[i])\r\n    }\r\n    return bytes\r\n  }\r\n  writeInt(i: number, field: string) {\r\n    immediate(writeIntLog, i, field)\r\n\r\n    this.checkLength(4)\r\n    this.intView[this.offset / 4] = i\r\n    this.offset += 4\r\n  }\r\n  writePair(n1: number, n2: number, field1: string, field2: string) {\r\n    this.writeInt(n1, field1)\r\n    this.writeInt(n2, field2)\r\n  }\r\n  addPadding() {\r\n    while (this.offset % 4)\r\n      this.next(0)\r\n  }\r\n}\r\n\r\nexport class TypeBuffer {\r\n  offset: number = 0\r\n  buffer: Buffer\r\n  intView: Uint32Array\r\n  byteView: Uint8Array\r\n  constructor(buffer: Buffer) {\r\n    this.buffer = buffer\r\n    this.intView = toUint32(buffer)\r\n    this.byteView = new Uint8Array(buffer)\r\n  }\r\n\r\n  nextByte() {\r\n    return this.byteView[this.offset++]\r\n  }\r\n  nextInt() {\r\n    if (this.offset >= this.intView.length * 4)\r\n      throw new TypeBufferIntError(this)\r\n    const int = this.intView[this.offset / 4]\r\n    this.offset += 4\r\n    return int\r\n  }\r\n  readPair(field1: string, field2: string) {\r\n    const int1 = this.nextInt(field1)\r\n    const int2 = this.nextInt(field2)\r\n    return [ int1, int2 ]\r\n  }\r\n  next(length: number) {\r\n    const result = this.byteView.subarray(this.offset, this.offset + length)\r\n    this.offset += length\r\n    return result\r\n  }\r\n  isEnd() {\r\n    return this.offset === this.byteView.length\r\n  }\r\n  addPadding() {\r\n    const offset = this.offset % 4\r\n    if (offset > 0)\r\n      this.offset += 4 - offset\r\n  }\r\n}\r\n\r\nconst toUint32 = (buf: Buffer) => {\r\n  let ln, res\r\n  if (!isNode) //TODO browser behavior not equals, why?\r\n    return new Uint32Array( buf )\r\n  if (buf.readUInt32LE) {\r\n    ln = buf.byteLength / 4\r\n    res = new Uint32Array( ln )\r\n    for (let i = 0; i < ln; i++)\r\n      res[i] = buf.readUInt32LE( i*4 )\r\n  } else {\r\n    //$FlowIssue\r\n    const data = new DataView( buf )\r\n    ln = data.byteLength / 4\r\n    res = new Uint32Array( ln )\r\n    for (let i = 0; i < ln; i++)\r\n      res[i] = data.getUint32( i*4, true )\r\n  }\r\n  return res\r\n}\r\n"]}