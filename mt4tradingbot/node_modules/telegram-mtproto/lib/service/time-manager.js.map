{"version":3,"sources":["../../src/service/time-manager.js"],"names":["dTime","log","tsNow","seconds","t","Date","window","tsOffset","Math","floor","lastMessageID","timerOffset","offset","get","generateMessageID","timeTicks","timeSec","timeMSec","random","messageID","applyServerTime","serverTime","localTime","newTimeOffset","changed","abs","set","generateID"],"mappings":";;;;;;;;;;;;kBAkBSA,K;;;;AAlBT;;;;AAEA;;AACA;;AAEA;;;;;;AAEA,IAAMC,MAAM,aAAO,cAAnB;;AAEO,IAAMC,wBAAQC,WAAW;AAC9B,MAAIC,IAAI,CAAC,IAAIC,IAAJ,EAAT;AACA;AACA,MAAI,qBAAJ,EAAaD,KAAKE,OAAOC,QAAP,IAAmB,CAAxB;AACb,SAAOJ,UACHK,KAAKC,KAAL,CAAWL,IAAI,IAAf,CADG,GAEHA,CAFJ;AAGD,CAPM;;AAWP,IAAIM,gBAAgB,CAAC,CAAD,EAAI,CAAJ,CAApB;AACA,IAAIC,cAAc,CAAlB;;AAEA,IAAMC,SAAS,kBAAWC,GAAX,EAAf;AACA,IAAID,MAAJ,EAAYD,cAAcC,MAAd;;AAEZ,IAAME,oBAAoB,MAAM;AAC9B,MAAMC,YAAYb,OAAlB;AAAA,MACMc,UAAUR,KAAKC,KAAL,CAAWM,YAAY,IAAvB,IAA+BJ,WAD/C;AAAA,MAEMM,WAAWF,YAAY,IAF7B;AAAA,MAGMG,SAAS,wBAAc,MAAd,CAHf;;AAKA,MAAIC,YAAY,CAACH,OAAD,EAAUC,YAAY,EAAZ,GAAiBC,UAAU,CAA3B,GAA+B,CAAzC,CAAhB;AACA,MAAIR,cAAc,CAAd,IAAmBS,UAAU,CAAV,CAAnB,IACFT,cAAc,CAAd,KAAoBS,UAAU,CAAV,CAApB,IAAoCT,cAAc,CAAd,KAAoBS,UAAU,CAAV,CAD1D,EACwE;AACtEA,gBAAY,CAACT,cAAc,CAAd,CAAD,EAAmBA,cAAc,CAAd,IAAmB,CAAtC,CAAZ;AACD;;AAEDA,kBAAgBS,SAAhB;;AAEA;;AAEA,SAAO,mBAASA,UAAU,CAAV,CAAT,EAAuBA,UAAU,CAAV,CAAvB,CAAP;AACD,CAjBD;;AAmBO,IAAMC,4CAAkB,CAACC,UAAD,EAAaC,SAAb,KAA2B;AACxD,MAAMC,gBAAgBF,aAAab,KAAKC,KAAL,CAAW,CAACa,aAAapB,OAAd,IAAyB,IAApC,CAAnC;AACA,MAAMsB,UAAUhB,KAAKiB,GAAL,CAASd,cAAcY,aAAvB,IAAwC,EAAxD;AACA,oBAAWG,GAAX,CAAeH,aAAf;;AAEAb,kBAAgB,CAAC,CAAD,EAAI,CAAJ,CAAhB;AACAC,gBAAcY,aAAd;AACAtB,MAAI,mBAAJ,EAAyBoB,UAAzB,EAAqCC,SAArC,EAAgDC,aAAhD,EAA+DC,OAA/D;;AAEA,SAAOA,OAAP;AACD,CAVM;;QAYuBG,U,GAArBb,iB","file":"time-manager.js","sourcesContent":["import isNode from 'detect-node'\r\n\r\nimport { TimeOffset } from '../store'\r\nimport { nextRandomInt, lshift32 } from '../bin'\r\n\r\nimport Logger from '../util/log'\r\n\r\nconst log = Logger`time-manager`\r\n\r\nexport const tsNow = seconds => {\r\n  let t = +new Date()\r\n  //eslint-disable-next-line\r\n  if (!isNode) t += window.tsOffset || 0\r\n  return seconds\r\n    ? Math.floor(t / 1000)\r\n    : t\r\n}\r\n\r\nexport { dTime } from '../util/dtime'\r\n\r\nlet lastMessageID = [0, 0]\r\nlet timerOffset = 0\r\n\r\nconst offset = TimeOffset.get()\r\nif (offset) timerOffset = offset\r\n\r\nconst generateMessageID = () => {\r\n  const timeTicks = tsNow(),\r\n        timeSec = Math.floor(timeTicks / 1000) + timerOffset,\r\n        timeMSec = timeTicks % 1000,\r\n        random = nextRandomInt(0xFFFF)\r\n\r\n  let messageID = [timeSec, timeMSec << 21 | random << 3 | 4]\r\n  if (lastMessageID[0] > messageID[0] ||\r\n    lastMessageID[0] == messageID[0] && lastMessageID[1] >= messageID[1]) {\r\n    messageID = [lastMessageID[0], lastMessageID[1] + 4]\r\n  }\r\n\r\n  lastMessageID = messageID\r\n\r\n  // console.log('generated msg id', messageID, timerOffset)\r\n\r\n  return lshift32(messageID[0], messageID[1])\r\n}\r\n\r\nexport const applyServerTime = (serverTime, localTime) => {\r\n  const newTimeOffset = serverTime - Math.floor((localTime || tsNow()) / 1000)\r\n  const changed = Math.abs(timerOffset - newTimeOffset) > 10\r\n  TimeOffset.set(newTimeOffset)\r\n\r\n  lastMessageID = [0, 0]\r\n  timerOffset = newTimeOffset\r\n  log('Apply server time')(serverTime, localTime, newTimeOffset, changed)\r\n\r\n  return changed\r\n}\r\n\r\nexport { generateMessageID as generateID }\r\n"]}